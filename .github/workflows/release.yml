name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  id-token: write

concurrency:
  group: release-main
  cancel-in-progress: false

jobs:
  validate:
    if: ${{ github.event_name != 'push' || !contains(github.event.head_commit.message, '[skip release]') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Prepare artifacts directory
        run: |
          set -euo pipefail
          mkdir -p artifacts/logs

      # - name: Lint
      #   run: |
      #     set -euo pipefail
      #     npm run lint 2>&1 | tee artifacts/logs/lint.log

      - name: Verify metadata
        run: |
          set -euo pipefail
          npm run verify:metadata 2>&1 | tee artifacts/logs/metadata.log

      - name: Unit tests
        run: |
          set -euo pipefail
          npm run test:unit:compiled 2>&1 | tee artifacts/logs/unit-tests.log

      - name: Extension tests
        env:
          BABYSITTER_HEADLESS: 1
        run: |
          set -euo pipefail
          dbus-run-session -- xvfb-run -a npm run test:extension:compiled 2>&1 | tee artifacts/logs/extension-tests.log

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: artifacts/logs
          if-no-files-found: warn

  version_and_release:
    if: ${{ github.event_name != 'push' || !contains(github.event.head_commit.message, '[skip release]') }}
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          registry-url: https://registry.npmjs.org/
          always-auth: true

      - name: Install dependencies
        run: npm ci

      - name: Download build logs
        uses: actions/download-artifact@v4
        with:
          name: build-logs
          path: artifacts/logs

      - name: Prepare release artifacts directory
        run: |
          set -euo pipefail
          mkdir -p artifacts/release


      - name: Bump version and changelog
        id: bump
        run: |
          set -euo pipefail
          VERSION=$(node scripts/bump-version.mjs)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Generate release notes
        run: |
          set -euo pipefail
          node scripts/release-notes.mjs > release-notes.md

      - name: Commit release metadata
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json packages/breakpoints/package.json packages/sdk/package.json packages/babysitter/package.json package-lock.json CHANGELOG.md plugins/babysitter/.claude-plugin/plugin.json plugins/babysitter/plugin.json .claude-plugin/marketplace.json
          if git diff --cached --quiet; then
            echo "No version changes detected."
          else
            TARGET_BRANCH=${BRANCH_NAME:-${GITHUB_REF##*/}}
            git commit -m "chore(release): v${{ steps.bump.outputs.version }} [skip release]"
            git push origin HEAD:$TARGET_BRANCH
          fi

      - name: Build npm package
        run: |
          set -euo pipefail
          npm run build

      - name: Build SDK package
        run: |
          set -euo pipefail
          npm run --workspace=@a5c-ai/babysitter-sdk build

      - name: Pack npm artifacts
        run: |
          set -euo pipefail
          npm pack --workspace=@a5c-ai/babysitter-sdk --pack-destination artifacts/release
          (cd packages/breakpoints && npm pack --pack-destination ../../artifacts/release)
          (cd packages/babysitter && npm pack --pack-destination ../../artifacts/release)

      - name: Generate artifact checksums
        run: |
          set -euo pipefail
          shopt -s nullglob
          artifacts=( artifacts/release/*.tgz )
          if [[ ${#artifacts[@]} -eq 0 ]]; then
            echo "Release artifacts missing" >&2
            exit 1
          fi
          (cd artifacts/release && sha256sum *.tgz > artifacts.sha256)

      - name: Publish SDK to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          npm publish --workspace=@a5c-ai/babysitter-sdk --access public

      - name: Publish breakpoints to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          npm publish --access public
        working-directory: packages/breakpoints

      - name: Publish babysitter metapackage to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          npm publish --access public
        working-directory: packages/babysitter

      - name: Tag release
        run: |
          set -euo pipefail
          TAG="v${{ steps.bump.outputs.version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            git tag -d "$TAG"
          fi
          git tag "$TAG"
          git push origin "$TAG"

      - name: Publish GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="v${{ steps.bump.outputs.version }}"
          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release delete "$TAG" -y
          fi
          ASSETS=(artifacts/release/*)
          if [[ ${#ASSETS[@]} -eq 0 ]]; then
            echo "Release artifacts missing" >&2
            exit 1
          fi
          gh release create "$TAG" "${ASSETS[@]}" \
            --title "Babysitter $TAG" \
            --notes-file release-notes.md
