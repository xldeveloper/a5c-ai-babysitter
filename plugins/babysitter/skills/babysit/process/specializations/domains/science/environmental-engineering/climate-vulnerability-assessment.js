/**
 * @process environmental-engineering/climate-vulnerability-assessment
 * @description Climate Vulnerability Assessment - Evaluation of infrastructure and system vulnerability to climate change
 * impacts including extreme weather, sea level rise, and temperature changes.
 * @inputs { entityName: string, assessmentScope: object, climateScenarios: array, assetInventory: object }
 * @outputs { success: boolean, vulnerabilityAssessment: object, riskMatrix: object, adaptationOptions: array, artifacts: array }
 *
 * @example
 * const result = await orchestrate('environmental-engineering/climate-vulnerability-assessment', {
 *   entityName: 'Municipal Water System',
 *   assessmentScope: { type: 'infrastructure', sector: 'water' },
 *   climateScenarios: ['RCP4.5', 'RCP8.5'],
 *   assetInventory: { assets: ['treatment-plant', 'distribution-system', 'reservoirs'] }
 * });
 *
 * @references
 * - IPCC Climate Change Reports
 * - EPA Climate Change Adaptation Resource Center
 * - FEMA Hazard Mitigation Planning
 * - USGCRP National Climate Assessment
 */

import { defineTask } from '@a5c-ai/babysitter-sdk';

export async function process(inputs, ctx) {
  const {
    entityName,
    assessmentScope = {},
    climateScenarios = ['RCP4.5', 'RCP8.5'],
    assetInventory = {},
    timeHorizons = [2030, 2050, 2100],
    outputDir = 'climate-vulnerability-output'
  } = inputs;

  const startTime = ctx.now();
  const artifacts = [];

  ctx.log('info', `Starting Climate Vulnerability Assessment: ${entityName}`);
  ctx.log('info', `Scenarios: ${climateScenarios.join(', ')}`);

  // ============================================================================
  // PHASE 1: CLIMATE HAZARD IDENTIFICATION
  // ============================================================================

  ctx.log('info', 'Phase 1: Climate Hazard Identification');

  const hazardIdentification = await ctx.task(climateHazardTask, {
    entityName,
    assessmentScope,
    climateScenarios,
    timeHorizons,
    outputDir
  });

  artifacts.push(...hazardIdentification.artifacts);

  // ============================================================================
  // PHASE 2: EXPOSURE ANALYSIS
  // ============================================================================

  ctx.log('info', 'Phase 2: Exposure Analysis');

  const exposureAnalysis = await ctx.task(climateExposureTask, {
    entityName,
    assetInventory,
    hazardIdentification,
    outputDir
  });

  artifacts.push(...exposureAnalysis.artifacts);

  // ============================================================================
  // PHASE 3: SENSITIVITY ANALYSIS
  // ============================================================================

  ctx.log('info', 'Phase 3: Sensitivity Analysis');

  const sensitivityAnalysis = await ctx.task(climateSensitivityTask, {
    entityName,
    assetInventory,
    hazardIdentification,
    exposureAnalysis,
    outputDir
  });

  artifacts.push(...sensitivityAnalysis.artifacts);

  // ============================================================================
  // PHASE 4: ADAPTIVE CAPACITY ASSESSMENT
  // ============================================================================

  ctx.log('info', 'Phase 4: Adaptive Capacity Assessment');

  const adaptiveCapacity = await ctx.task(adaptiveCapacityTask, {
    entityName,
    assessmentScope,
    outputDir
  });

  artifacts.push(...adaptiveCapacity.artifacts);

  // ============================================================================
  // PHASE 5: VULNERABILITY SCORING
  // ============================================================================

  ctx.log('info', 'Phase 5: Vulnerability Scoring');

  const vulnerabilityScoring = await ctx.task(vulnerabilityScoringTask, {
    entityName,
    hazardIdentification,
    exposureAnalysis,
    sensitivityAnalysis,
    adaptiveCapacity,
    outputDir
  });

  artifacts.push(...vulnerabilityScoring.artifacts);

  // Breakpoint: Vulnerability Review
  await ctx.breakpoint({
    question: `Vulnerability assessment complete for ${entityName}. High vulnerability assets: ${vulnerabilityScoring.highVulnerabilityCount}. Review results?`,
    title: 'Climate Vulnerability Review',
    context: {
      runId: ctx.runId,
      overallVulnerability: vulnerabilityScoring.overallVulnerability,
      highVulnerabilityAssets: vulnerabilityScoring.highVulnerabilityCount,
      files: vulnerabilityScoring.artifacts.map(a => ({ path: a.path, format: a.format || 'json' }))
    }
  });

  // ============================================================================
  // PHASE 6: RISK ASSESSMENT
  // ============================================================================

  ctx.log('info', 'Phase 6: Climate Risk Assessment');

  const riskAssessment = await ctx.task(climateRiskTask, {
    entityName,
    vulnerabilityScoring,
    hazardIdentification,
    timeHorizons,
    outputDir
  });

  artifacts.push(...riskAssessment.artifacts);

  // ============================================================================
  // PHASE 7: ADAPTATION OPTIONS
  // ============================================================================

  ctx.log('info', 'Phase 7: Adaptation Options Development');

  const adaptationOptions = await ctx.task(adaptationOptionsTask, {
    entityName,
    vulnerabilityScoring,
    riskAssessment,
    outputDir
  });

  artifacts.push(...adaptationOptions.artifacts);

  // ============================================================================
  // PHASE 8: VULNERABILITY REPORT
  // ============================================================================

  ctx.log('info', 'Phase 8: Vulnerability Report');

  const vulnerabilityReport = await ctx.task(vulnerabilityReportTask, {
    entityName,
    hazardIdentification,
    exposureAnalysis,
    sensitivityAnalysis,
    adaptiveCapacity,
    vulnerabilityScoring,
    riskAssessment,
    adaptationOptions,
    outputDir
  });

  artifacts.push(...vulnerabilityReport.artifacts);

  const endTime = ctx.now();
  const duration = endTime - startTime;

  return {
    success: true,
    entityName,
    vulnerabilityAssessment: {
      overallVulnerability: vulnerabilityScoring.overallVulnerability,
      byAsset: vulnerabilityScoring.byAsset,
      byHazard: vulnerabilityScoring.byHazard,
      highVulnerabilityCount: vulnerabilityScoring.highVulnerabilityCount
    },
    riskMatrix: {
      riskRankings: riskAssessment.riskRankings,
      highRisks: riskAssessment.highRisks,
      timeHorizonImpacts: riskAssessment.timeHorizonImpacts
    },
    adaptationOptions: adaptationOptions.options,
    climateHazards: hazardIdentification.hazards,
    artifacts,
    duration,
    metadata: {
      processId: 'environmental-engineering/climate-vulnerability-assessment',
      timestamp: startTime,
      outputDir
    }
  };
}

// ============================================================================
// TASK DEFINITIONS
// ============================================================================

export const climateHazardTask = defineTask('climate-hazard', (args, taskCtx) => ({
  kind: 'agent',
  title: 'Climate Hazard Identification',
  agent: {
    name: 'environmental-engineer',
    prompt: {
      role: 'Climate Hazard Analyst',
      task: 'Identify climate hazards for vulnerability assessment',
      context: args,
      instructions: [
        '1. Review climate projections for region',
        '2. Identify temperature-related hazards',
        '3. Identify precipitation-related hazards',
        '4. Identify sea level rise impacts',
        '5. Identify extreme weather events',
        '6. Project hazard changes by scenario',
        '7. Characterize hazard magnitude',
        '8. Characterize hazard frequency',
        '9. Document uncertainty ranges',
        '10. Prepare hazard summary'
      ],
      outputFormat: 'JSON with hazards, projections, uncertainties'
    },
    outputSchema: {
      type: 'object',
      required: ['hazards', 'projections', 'uncertainties', 'artifacts'],
      properties: {
        hazards: { type: 'array' },
        temperatureHazards: { type: 'object' },
        precipitationHazards: { type: 'object' },
        seaLevelRise: { type: 'object' },
        extremeEvents: { type: 'object' },
        projections: { type: 'object' },
        uncertainties: { type: 'object' },
        artifacts: { type: 'array' }
      }
    }
  },
  io: {
    inputJsonPath: `tasks/${taskCtx.effectId}/input.json`,
    outputJsonPath: `tasks/${taskCtx.effectId}/result.json`
  },
  labels: ['agent', 'environmental-engineering', 'climate', 'hazard']
}));

export const climateExposureTask = defineTask('climate-exposure', (args, taskCtx) => ({
  kind: 'agent',
  title: 'Exposure Analysis',
  agent: {
    name: 'environmental-engineer',
    prompt: {
      role: 'Climate Exposure Analyst',
      task: 'Analyze exposure of assets to climate hazards',
      context: args,
      instructions: [
        '1. Inventory assets and systems',
        '2. Map asset locations',
        '3. Overlay hazard projections',
        '4. Identify exposed assets',
        '5. Characterize exposure levels',
        '6. Assess geographic exposure',
        '7. Assess temporal exposure',
        '8. Identify critical exposures',
        '9. Document exposure findings',
        '10. Prepare exposure summary'
      ],
      outputFormat: 'JSON with exposure analysis, exposed assets, levels'
    },
    outputSchema: {
      type: 'object',
      required: ['exposureAnalysis', 'exposedAssets', 'exposureLevels', 'artifacts'],
      properties: {
        exposureAnalysis: { type: 'object' },
        assetInventory: { type: 'array' },
        exposedAssets: { type: 'array' },
        exposureLevels: { type: 'object' },
        geographicExposure: { type: 'object' },
        criticalExposures: { type: 'array' },
        artifacts: { type: 'array' }
      }
    }
  },
  io: {
    inputJsonPath: `tasks/${taskCtx.effectId}/input.json`,
    outputJsonPath: `tasks/${taskCtx.effectId}/result.json`
  },
  labels: ['agent', 'environmental-engineering', 'climate', 'exposure']
}));

export const climateSensitivityTask = defineTask('climate-sensitivity', (args, taskCtx) => ({
  kind: 'agent',
  title: 'Sensitivity Analysis',
  agent: {
    name: 'environmental-engineer',
    prompt: {
      role: 'Climate Sensitivity Analyst',
      task: 'Assess sensitivity of assets to climate impacts',
      context: args,
      instructions: [
        '1. Assess physical sensitivity',
        '2. Assess operational sensitivity',
        '3. Assess design threshold exceedances',
        '4. Evaluate material vulnerabilities',
        '5. Assess system interdependencies',
        '6. Evaluate cascade failure potential',
        '7. Assess recovery times',
        '8. Score sensitivity levels',
        '9. Document sensitivity findings',
        '10. Prepare sensitivity summary'
      ],
      outputFormat: 'JSON with sensitivity scores, thresholds, interdependencies'
    },
    outputSchema: {
      type: 'object',
      required: ['sensitivityScores', 'thresholds', 'interdependencies', 'artifacts'],
      properties: {
        sensitivityScores: { type: 'object' },
        physicalSensitivity: { type: 'object' },
        operationalSensitivity: { type: 'object' },
        thresholds: { type: 'object' },
        materialVulnerabilities: { type: 'array' },
        interdependencies: { type: 'array' },
        cascadeFailures: { type: 'array' },
        artifacts: { type: 'array' }
      }
    }
  },
  io: {
    inputJsonPath: `tasks/${taskCtx.effectId}/input.json`,
    outputJsonPath: `tasks/${taskCtx.effectId}/result.json`
  },
  labels: ['agent', 'environmental-engineering', 'climate', 'sensitivity']
}));

export const adaptiveCapacityTask = defineTask('adaptive-capacity', (args, taskCtx) => ({
  kind: 'agent',
  title: 'Adaptive Capacity Assessment',
  agent: {
    name: 'environmental-engineer',
    prompt: {
      role: 'Adaptive Capacity Analyst',
      task: 'Assess adaptive capacity to climate impacts',
      context: args,
      instructions: [
        '1. Assess institutional capacity',
        '2. Assess financial capacity',
        '3. Assess technical capacity',
        '4. Assess social capacity',
        '5. Evaluate existing adaptation measures',
        '6. Assess monitoring capabilities',
        '7. Evaluate response capacity',
        '8. Assess knowledge and awareness',
        '9. Score adaptive capacity',
        '10. Document adaptive capacity'
      ],
      outputFormat: 'JSON with capacity scores, strengths, gaps'
    },
    outputSchema: {
      type: 'object',
      required: ['capacityScores', 'strengths', 'gaps', 'artifacts'],
      properties: {
        capacityScores: { type: 'object' },
        institutionalCapacity: { type: 'object' },
        financialCapacity: { type: 'object' },
        technicalCapacity: { type: 'object' },
        existingMeasures: { type: 'array' },
        strengths: { type: 'array' },
        gaps: { type: 'array' },
        artifacts: { type: 'array' }
      }
    }
  },
  io: {
    inputJsonPath: `tasks/${taskCtx.effectId}/input.json`,
    outputJsonPath: `tasks/${taskCtx.effectId}/result.json`
  },
  labels: ['agent', 'environmental-engineering', 'climate', 'adaptive-capacity']
}));

export const vulnerabilityScoringTask = defineTask('vulnerability-scoring', (args, taskCtx) => ({
  kind: 'agent',
  title: 'Vulnerability Scoring',
  agent: {
    name: 'environmental-engineer',
    prompt: {
      role: 'Vulnerability Scoring Specialist',
      task: 'Calculate vulnerability scores',
      context: args,
      instructions: [
        '1. Combine exposure, sensitivity, adaptive capacity',
        '2. Calculate vulnerability by asset',
        '3. Calculate vulnerability by hazard',
        '4. Normalize vulnerability scores',
        '5. Identify high vulnerability assets',
        '6. Rank vulnerabilities',
        '7. Calculate overall vulnerability',
        '8. Visualize vulnerability results',
        '9. Document scoring methodology',
        '10. Prepare vulnerability summary'
      ],
      outputFormat: 'JSON with overall vulnerability, by asset, by hazard'
    },
    outputSchema: {
      type: 'object',
      required: ['overallVulnerability', 'byAsset', 'byHazard', 'highVulnerabilityCount', 'artifacts'],
      properties: {
        overallVulnerability: { type: 'string' },
        byAsset: { type: 'object' },
        byHazard: { type: 'object' },
        vulnerabilityRankings: { type: 'array' },
        highVulnerabilityCount: { type: 'number' },
        scoringMethodology: { type: 'object' },
        artifacts: { type: 'array' }
      }
    }
  },
  io: {
    inputJsonPath: `tasks/${taskCtx.effectId}/input.json`,
    outputJsonPath: `tasks/${taskCtx.effectId}/result.json`
  },
  labels: ['agent', 'environmental-engineering', 'climate', 'vulnerability']
}));

export const climateRiskTask = defineTask('climate-risk', (args, taskCtx) => ({
  kind: 'agent',
  title: 'Climate Risk Assessment',
  agent: {
    name: 'environmental-engineer',
    prompt: {
      role: 'Climate Risk Analyst',
      task: 'Assess climate risks based on vulnerability',
      context: args,
      instructions: [
        '1. Assess likelihood of impacts',
        '2. Assess consequence severity',
        '3. Calculate risk scores',
        '4. Develop risk matrix',
        '5. Identify high risks',
        '6. Assess risks by time horizon',
        '7. Evaluate cascading risks',
        '8. Prioritize risks',
        '9. Document risk assessment',
        '10. Prepare risk summary'
      ],
      outputFormat: 'JSON with risk rankings, high risks, time horizon impacts'
    },
    outputSchema: {
      type: 'object',
      required: ['riskRankings', 'highRisks', 'timeHorizonImpacts', 'artifacts'],
      properties: {
        riskRankings: { type: 'array' },
        riskMatrix: { type: 'object' },
        likelihood: { type: 'object' },
        consequences: { type: 'object' },
        highRisks: { type: 'array' },
        timeHorizonImpacts: { type: 'object' },
        cascadingRisks: { type: 'array' },
        artifacts: { type: 'array' }
      }
    }
  },
  io: {
    inputJsonPath: `tasks/${taskCtx.effectId}/input.json`,
    outputJsonPath: `tasks/${taskCtx.effectId}/result.json`
  },
  labels: ['agent', 'environmental-engineering', 'climate', 'risk']
}));

export const adaptationOptionsTask = defineTask('adaptation-options', (args, taskCtx) => ({
  kind: 'agent',
  title: 'Adaptation Options Development',
  agent: {
    name: 'environmental-engineer',
    prompt: {
      role: 'Climate Adaptation Planner',
      task: 'Develop climate adaptation options',
      context: args,
      instructions: [
        '1. Identify structural adaptation options',
        '2. Identify operational adaptations',
        '3. Identify policy/planning adaptations',
        '4. Identify nature-based solutions',
        '5. Assess option effectiveness',
        '6. Estimate adaptation costs',
        '7. Evaluate co-benefits',
        '8. Assess implementation feasibility',
        '9. Prioritize options',
        '10. Document adaptation options'
      ],
      outputFormat: 'JSON with options, effectiveness, costs'
    },
    outputSchema: {
      type: 'object',
      required: ['options', 'effectiveness', 'costs', 'artifacts'],
      properties: {
        options: { type: 'array' },
        structuralOptions: { type: 'array' },
        operationalOptions: { type: 'array' },
        policyOptions: { type: 'array' },
        natureBasedSolutions: { type: 'array' },
        effectiveness: { type: 'object' },
        costs: { type: 'object' },
        coBenefits: { type: 'object' },
        prioritization: { type: 'array' },
        artifacts: { type: 'array' }
      }
    }
  },
  io: {
    inputJsonPath: `tasks/${taskCtx.effectId}/input.json`,
    outputJsonPath: `tasks/${taskCtx.effectId}/result.json`
  },
  labels: ['agent', 'environmental-engineering', 'climate', 'adaptation']
}));

export const vulnerabilityReportTask = defineTask('vulnerability-report', (args, taskCtx) => ({
  kind: 'agent',
  title: 'Vulnerability Report',
  agent: {
    name: 'environmental-engineer',
    prompt: {
      role: 'Climate Vulnerability Report Writer',
      task: 'Generate climate vulnerability assessment report',
      context: args,
      instructions: [
        '1. Prepare executive summary',
        '2. Document methodology',
        '3. Present climate hazard analysis',
        '4. Present exposure analysis',
        '5. Present sensitivity analysis',
        '6. Present adaptive capacity',
        '7. Present vulnerability results',
        '8. Present risk assessment',
        '9. Present adaptation options',
        '10. Generate final report'
      ],
      outputFormat: 'JSON with report path, executive summary, recommendations'
    },
    outputSchema: {
      type: 'object',
      required: ['reportPath', 'executiveSummary', 'recommendations', 'artifacts'],
      properties: {
        reportPath: { type: 'string' },
        executiveSummary: { type: 'string' },
        keyFindings: { type: 'array' },
        recommendations: { type: 'array' },
        adaptationPriorities: { type: 'array' },
        artifacts: { type: 'array' }
      }
    }
  },
  io: {
    inputJsonPath: `tasks/${taskCtx.effectId}/input.json`,
    outputJsonPath: `tasks/${taskCtx.effectId}/result.json`
  },
  labels: ['agent', 'environmental-engineering', 'climate', 'reporting']
}));
