/**
 * @process specializations/domains/social-sciences-humanities/healthcare/population-health-management
 * @description Population Health Management - Framework for managing and improving the health outcomes
 * of defined patient populations through risk stratification, care management, and data analytics.
 * @inputs { organizationName: string, populationScope?: string, riskCategories?: array, valueBased?: boolean }
 * @outputs { success: boolean, populationProgram: object, careModels: array, analytics: object, artifacts: array }
 */

import { defineTask } from '@a5c-ai/babysitter-sdk';

export async function process(inputs, ctx) {
  const { organizationName, populationScope = 'attributed-lives', riskCategories = [], valueBased = true, outputDir = 'population-health-output' } = inputs;
  const startTime = ctx.now();
  const artifacts = [];

  ctx.log('info', `Starting Population Health Management Program for: ${organizationName}`);

  const populationAssessment = await ctx.task(phAssessmentTask, { organizationName, populationScope, riskCategories, outputDir });
  artifacts.push(...populationAssessment.artifacts);

  await ctx.breakpoint({ question: `Population assessed. ${populationAssessment.totalPopulation} patients. High-risk: ${populationAssessment.riskDistribution.high}%. Proceed with stratification?`, title: 'Population Assessment Review', context: { runId: ctx.runId, population: populationAssessment.totalPopulation, risk: populationAssessment.riskDistribution } });

  const riskStratification = await ctx.task(phRiskStratificationTask, { populationAssessment, outputDir });
  artifacts.push(...riskStratification.artifacts);

  const careManagementModels = await ctx.task(phCareManagementTask, { riskStratification, outputDir });
  artifacts.push(...careManagementModels.artifacts);

  const chronicCarePrograms = await ctx.task(phChronicCareTask, { riskStratification, outputDir });
  artifacts.push(...chronicCarePrograms.artifacts);

  await ctx.breakpoint({ question: `Care management models designed for ${careManagementModels.models.length} risk tiers. ${chronicCarePrograms.programs.length} chronic care programs. Proceed?`, title: 'Care Models Review', context: { runId: ctx.runId, models: careManagementModels.models, programs: chronicCarePrograms.programs } });

  const wellnessPrograms = await ctx.task(phWellnessTask, { populationAssessment, outputDir });
  artifacts.push(...wellnessPrograms.artifacts);

  const sdohIntegration = await ctx.task(phSDOHTask, { populationAssessment, outputDir });
  artifacts.push(...sdohIntegration.artifacts);

  const analyticsInfrastructure = await ctx.task(phAnalyticsTask, { populationAssessment, riskStratification, outputDir });
  artifacts.push(...analyticsInfrastructure.artifacts);

  const providerEngagement = await ctx.task(phProviderEngagementTask, { careManagementModels, outputDir });
  artifacts.push(...providerEngagement.artifacts);

  const outcomesMeasurement = await ctx.task(phOutcomesTask, { valueBased, outputDir });
  artifacts.push(...outcomesMeasurement.artifacts);

  const implementationPlan = await ctx.task(phImplementationTask, { careManagementModels, chronicCarePrograms, analyticsInfrastructure, outputDir });
  artifacts.push(...implementationPlan.artifacts);

  const documentation = await ctx.task(phDocumentationTask, { organizationName, populationAssessment, riskStratification, careManagementModels, chronicCarePrograms, wellnessPrograms, sdohIntegration, analyticsInfrastructure, providerEngagement, outcomesMeasurement, implementationPlan, outputDir });
  artifacts.push(...documentation.artifacts);

  return { success: true, organizationName, populationProgram: { population: populationAssessment.totalPopulation, riskDistribution: riskStratification.distribution, stratificationModel: riskStratification.model }, careModels: careManagementModels.models, analytics: analyticsInfrastructure.infrastructure, artifacts, duration: ctx.now() - startTime, metadata: { processId: 'specializations/domains/social-sciences-humanities/healthcare/population-health-management', timestamp: startTime, outputDir } };
}

export const phAssessmentTask = defineTask('ph-assessment', (args, taskCtx) => ({ kind: 'agent', title: 'Population Health Assessment', agent: { name: 'population-analyst', prompt: { role: 'Population Health Analyst', task: 'Assess population health status', context: args, instructions: ['1. Define population scope', '2. Analyze demographic profile', '3. Review disease prevalence', '4. Assess utilization patterns', '5. Analyze cost distribution', '6. Review quality metrics', '7. Identify high-risk populations', '8. Assess social determinants', '9. Calculate risk distribution', '10. Document population assessment'], outputFormat: 'JSON with population assessment' }, outputSchema: { type: 'object', required: ['totalPopulation', 'riskDistribution', 'artifacts'], properties: { totalPopulation: { type: 'number' }, demographics: { type: 'object' }, riskDistribution: { type: 'object' }, diseasePrevalence: { type: 'object' }, utilizationPatterns: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'population-health', 'assessment', 'healthcare'] }));

export const phRiskStratificationTask = defineTask('ph-risk-stratification', (args, taskCtx) => ({ kind: 'agent', title: 'Risk Stratification', agent: { name: 'risk-stratification-specialist', prompt: { role: 'Risk Stratification Specialist', task: 'Design risk stratification model', context: args, instructions: ['1. Select risk model approach', '2. Define risk factors', '3. Design scoring methodology', '4. Create risk tiers', '5. Validate model accuracy', '6. Design refresh frequency', '7. Plan patient identification', '8. Create actionable segments', '9. Design registry structure', '10. Document stratification model'], outputFormat: 'JSON with risk stratification' }, outputSchema: { type: 'object', required: ['model', 'distribution', 'artifacts'], properties: { model: { type: 'object' }, methodology: { type: 'object' }, distribution: { type: 'object' }, tiers: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'population-health', 'risk', 'healthcare'] }));

export const phCareManagementTask = defineTask('ph-care-management', (args, taskCtx) => ({ kind: 'agent', title: 'Care Management Models', agent: { name: 'care-management-specialist', prompt: { role: 'Care Management Specialist', task: 'Design care management models', context: args, instructions: ['1. Design high-risk model', '2. Design rising-risk model', '3. Design moderate-risk model', '4. Define care manager roles', '5. Design care plan templates', '6. Define touchpoint frequency', '7. Design transition care', '8. Plan medication management', '9. Design referral pathways', '10. Document care models'], outputFormat: 'JSON with care management models' }, outputSchema: { type: 'object', required: ['models', 'workflows', 'artifacts'], properties: { models: { type: 'array', items: { type: 'object' } }, workflows: { type: 'array', items: { type: 'object' } }, carePlans: { type: 'object' }, staffingModel: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'population-health', 'care-management', 'healthcare'] }));

export const phChronicCareTask = defineTask('ph-chronic-care', (args, taskCtx) => ({ kind: 'agent', title: 'Chronic Care Programs', agent: { name: 'chronic-care-specialist', prompt: { role: 'Chronic Care Specialist', task: 'Design chronic care programs', context: args, instructions: ['1. Design diabetes program', '2. Design CHF program', '3. Design COPD program', '4. Design hypertension program', '5. Create evidence-based protocols', '6. Design patient education', '7. Plan remote monitoring', '8. Design self-management support', '9. Plan specialist integration', '10. Document chronic programs'], outputFormat: 'JSON with chronic care programs' }, outputSchema: { type: 'object', required: ['programs', 'protocols', 'artifacts'], properties: { programs: { type: 'array', items: { type: 'object' } }, protocols: { type: 'array', items: { type: 'object' } }, education: { type: 'object' }, monitoring: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'population-health', 'chronic-care', 'healthcare'] }));

export const phWellnessTask = defineTask('ph-wellness', (args, taskCtx) => ({ kind: 'agent', title: 'Wellness and Prevention Programs', agent: { name: 'wellness-specialist', prompt: { role: 'Wellness Program Specialist', task: 'Design wellness programs', context: args, instructions: ['1. Design preventive screening', '2. Create immunization programs', '3. Design health coaching', '4. Create fitness programs', '5. Design nutrition programs', '6. Plan behavioral health', '7. Design smoking cessation', '8. Create weight management', '9. Plan community programs', '10. Document wellness programs'], outputFormat: 'JSON with wellness programs' }, outputSchema: { type: 'object', required: ['wellnessPrograms', 'screening', 'artifacts'], properties: { wellnessPrograms: { type: 'array', items: { type: 'object' } }, screening: { type: 'object' }, coaching: { type: 'object' }, communityPrograms: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'population-health', 'wellness', 'healthcare'] }));

export const phSDOHTask = defineTask('ph-sdoh', (args, taskCtx) => ({ kind: 'agent', title: 'Social Determinants Integration', agent: { name: 'sdoh-specialist', prompt: { role: 'SDOH Specialist', task: 'Integrate social determinants', context: args, instructions: ['1. Design SDOH screening', '2. Create screening tools', '3. Design data capture', '4. Plan community referrals', '5. Design closed-loop referrals', '6. Create resource directory', '7. Plan community partnerships', '8. Design intervention tracking', '9. Plan outcome measurement', '10. Document SDOH program'], outputFormat: 'JSON with SDOH program' }, outputSchema: { type: 'object', required: ['sdohProgram', 'screening', 'artifacts'], properties: { sdohProgram: { type: 'object' }, screening: { type: 'object' }, referralNetwork: { type: 'array', items: { type: 'object' } }, partnerships: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'population-health', 'sdoh', 'healthcare'] }));

export const phAnalyticsTask = defineTask('ph-analytics', (args, taskCtx) => ({ kind: 'agent', title: 'Analytics Infrastructure', agent: { name: 'analytics-architect', prompt: { role: 'Population Health Analytics Architect', task: 'Design analytics infrastructure', context: args, instructions: ['1. Design data warehouse', '2. Plan data integration', '3. Design population dashboards', '4. Create predictive models', '5. Design care gap reporting', '6. Plan real-time alerts', '7. Design provider scorecards', '8. Plan outcomes reporting', '9. Design patient engagement', '10. Document analytics infrastructure'], outputFormat: 'JSON with analytics infrastructure' }, outputSchema: { type: 'object', required: ['infrastructure', 'dashboards', 'artifacts'], properties: { infrastructure: { type: 'object' }, dataIntegration: { type: 'object' }, dashboards: { type: 'array', items: { type: 'object' } }, predictiveModels: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'population-health', 'analytics', 'healthcare'] }));

export const phProviderEngagementTask = defineTask('ph-provider-engagement', (args, taskCtx) => ({ kind: 'agent', title: 'Provider Engagement Strategy', agent: { name: 'provider-engagement-specialist', prompt: { role: 'Provider Engagement Specialist', task: 'Design provider engagement', context: args, instructions: ['1. Design provider network', '2. Create care protocols', '3. Design performance feedback', '4. Plan provider education', '5. Design incentive alignment', '6. Create referral optimization', '7. Plan specialist integration', '8. Design care coordination', '9. Plan governance structure', '10. Document engagement strategy'], outputFormat: 'JSON with provider engagement' }, outputSchema: { type: 'object', required: ['engagementStrategy', 'incentives', 'artifacts'], properties: { engagementStrategy: { type: 'object' }, network: { type: 'object' }, incentives: { type: 'object' }, protocols: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'population-health', 'provider', 'healthcare'] }));

export const phOutcomesTask = defineTask('ph-outcomes', (args, taskCtx) => ({ kind: 'agent', title: 'Outcomes Measurement Framework', agent: { name: 'outcomes-analyst', prompt: { role: 'Outcomes Measurement Analyst', task: 'Design outcomes measurement', context: args, instructions: ['1. Define quality metrics', '2. Define cost metrics', '3. Define utilization metrics', '4. Define experience metrics', '5. Design population measures', '6. Plan benchmark comparison', '7. Design reporting cadence', '8. Plan ROI measurement', '9. Design continuous improvement', '10. Document outcomes framework'], outputFormat: 'JSON with outcomes framework' }, outputSchema: { type: 'object', required: ['outcomesFramework', 'metrics', 'artifacts'], properties: { outcomesFramework: { type: 'object' }, metrics: { type: 'array', items: { type: 'object' } }, targets: { type: 'object' }, reporting: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'population-health', 'outcomes', 'healthcare'] }));

export const phImplementationTask = defineTask('ph-implementation', (args, taskCtx) => ({ kind: 'agent', title: 'Population Health Implementation', agent: { name: 'implementation-manager', prompt: { role: 'Population Health Implementation Manager', task: 'Plan program implementation', context: args, instructions: ['1. Create implementation phases', '2. Define resource requirements', '3. Plan technology deployment', '4. Design training program', '5. Create communication plan', '6. Define success criteria', '7. Plan risk mitigation', '8. Create governance structure', '9. Plan change management', '10. Document implementation'], outputFormat: 'JSON with implementation plan' }, outputSchema: { type: 'object', required: ['plan', 'timeline', 'artifacts'], properties: { plan: { type: 'object' }, timeline: { type: 'object' }, resources: { type: 'object' }, governance: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'population-health', 'implementation', 'healthcare'] }));

export const phDocumentationTask = defineTask('ph-documentation', (args, taskCtx) => ({ kind: 'agent', title: 'Population Health Documentation', agent: { name: 'documentation-writer', prompt: { role: 'Population Health Documentation Writer', task: 'Document population health program', context: args, instructions: ['1. Write executive summary', '2. Document population assessment', '3. Include risk stratification', '4. Document care management', '5. Include chronic programs', '6. Document wellness programs', '7. Include SDOH integration', '8. Document analytics', '9. Include implementation plan', '10. Format professionally'], outputFormat: 'JSON with documentation' }, outputSchema: { type: 'object', required: ['documentPath', 'artifacts'], properties: { documentPath: { type: 'string' }, summary: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'population-health', 'documentation', 'healthcare'] }));
