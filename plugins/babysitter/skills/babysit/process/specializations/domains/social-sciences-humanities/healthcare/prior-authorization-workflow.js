/**
 * @process specializations/domains/social-sciences-humanities/healthcare/prior-authorization-workflow
 * @description Prior Authorization Workflow - Comprehensive process for managing prior authorizations
 * including submission, tracking, appeals, and automation of payer-specific requirements.
 * @inputs { organizationName: string, authScope?: string, serviceTypes?: array, payerMix?: object }
 * @outputs { success: boolean, authWorkflow: object, automationPlan: object, metrics: object, artifacts: array }
 */

import { defineTask } from '@a5c-ai/babysitter-sdk';

export async function process(inputs, ctx) {
  const { organizationName, authScope = 'enterprise', serviceTypes = [], payerMix = {}, outputDir = 'prior-auth-output' } = inputs;
  const startTime = ctx.now();
  const artifacts = [];

  ctx.log('info', `Starting Prior Authorization Workflow Design for: ${organizationName}`);

  const currentStateAssessment = await ctx.task(authCurrentStateTask, { organizationName, authScope, serviceTypes, outputDir });
  artifacts.push(...currentStateAssessment.artifacts);

  await ctx.breakpoint({ question: `Current state assessed. Auth approval rate: ${currentStateAssessment.approvalRate}%. Average turnaround: ${currentStateAssessment.avgTurnaround} days. Proceed?`, title: 'Auth Assessment Review', context: { runId: ctx.runId, approvalRate: currentStateAssessment.approvalRate, turnaround: currentStateAssessment.avgTurnaround } });

  const requirementsDatabase = await ctx.task(authRequirementsTask, { currentStateAssessment, payerMix, outputDir });
  artifacts.push(...requirementsDatabase.artifacts);

  const submissionWorkflow = await ctx.task(authSubmissionTask, { requirementsDatabase, serviceTypes, outputDir });
  artifacts.push(...submissionWorkflow.artifacts);

  const trackingSystem = await ctx.task(authTrackingTask, { submissionWorkflow, outputDir });
  artifacts.push(...trackingSystem.artifacts);

  await ctx.breakpoint({ question: `Submission workflow designed. ${submissionWorkflow.automationOpportunities.length} automation opportunities identified. Proceed with appeals process?`, title: 'Submission Workflow Review', context: { runId: ctx.runId, automation: submissionWorkflow.automationOpportunities } });

  const appealsProcess = await ctx.task(authAppealsTask, { currentStateAssessment, outputDir });
  artifacts.push(...appealsProcess.artifacts);

  const peerToPeerProcess = await ctx.task(peerToPeerTask, { appealsProcess, outputDir });
  artifacts.push(...peerToPeerProcess.artifacts);

  const automationPlan = await ctx.task(authAutomationTask, { submissionWorkflow, requirementsDatabase, outputDir });
  artifacts.push(...automationPlan.artifacts);

  const metricsMonitoring = await ctx.task(authMetricsTask, { currentStateAssessment, outputDir });
  artifacts.push(...metricsMonitoring.artifacts);

  const implementationPlan = await ctx.task(authImplementationTask, { submissionWorkflow, trackingSystem, automationPlan, outputDir });
  artifacts.push(...implementationPlan.artifacts);

  const documentation = await ctx.task(authDocumentationTask, { organizationName, currentStateAssessment, requirementsDatabase, submissionWorkflow, trackingSystem, appealsProcess, peerToPeerProcess, automationPlan, metricsMonitoring, implementationPlan, outputDir });
  artifacts.push(...documentation.artifacts);

  return { success: true, organizationName, authWorkflow: { submission: submissionWorkflow.workflow, tracking: trackingSystem.system, appeals: appealsProcess.workflow, peerToPeer: peerToPeerProcess.workflow }, automationPlan: automationPlan.plan, metrics: metricsMonitoring.metrics, artifacts, duration: ctx.now() - startTime, metadata: { processId: 'specializations/domains/social-sciences-humanities/healthcare/prior-authorization-workflow', timestamp: startTime, outputDir } };
}

export const authCurrentStateTask = defineTask('auth-current-state', (args, taskCtx) => ({ kind: 'agent', title: 'Auth Current State Assessment', agent: { name: 'auth-analyst', prompt: { role: 'Prior Authorization Analyst', task: 'Assess current authorization state', context: args, instructions: ['1. Analyze authorization volumes', '2. Review approval/denial rates', '3. Assess turnaround times', '4. Identify bottlenecks', '5. Review staff productivity', '6. Analyze payer variations', '7. Assess technology utilization', '8. Review appeal success rates', '9. Benchmark against industry', '10. Document assessment findings'], outputFormat: 'JSON with current state assessment' }, outputSchema: { type: 'object', required: ['approvalRate', 'avgTurnaround', 'artifacts'], properties: { approvalRate: { type: 'number' }, avgTurnaround: { type: 'number' }, volumes: { type: 'object' }, bottlenecks: { type: 'array', items: { type: 'object' } }, benchmarks: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'prior-auth', 'assessment', 'healthcare'] }));

export const authRequirementsTask = defineTask('auth-requirements', (args, taskCtx) => ({ kind: 'agent', title: 'Authorization Requirements Database', agent: { name: 'requirements-specialist', prompt: { role: 'Auth Requirements Specialist', task: 'Build authorization requirements database', context: args, instructions: ['1. Document payer-specific requirements', '2. Define service-level requirements', '3. Create documentation checklists', '4. Define timeline requirements', '5. Document clinical criteria', '6. Create CPT/HCPCS mapping', '7. Define notification requirements', '8. Document submission methods', '9. Create update process', '10. Document requirements database'], outputFormat: 'JSON with requirements database' }, outputSchema: { type: 'object', required: ['requirements', 'payerRules', 'artifacts'], properties: { requirements: { type: 'array', items: { type: 'object' } }, payerRules: { type: 'object' }, serviceMatrix: { type: 'object' }, documentationChecklists: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'prior-auth', 'requirements', 'healthcare'] }));

export const authSubmissionTask = defineTask('auth-submission', (args, taskCtx) => ({ kind: 'agent', title: 'Authorization Submission Workflow', agent: { name: 'submission-specialist', prompt: { role: 'Auth Submission Specialist', task: 'Design authorization submission workflow', context: args, instructions: ['1. Design intake process', '2. Create documentation gathering', '3. Define clinical review', '4. Design submission channels', '5. Create urgent auth workflow', '6. Define retro-auth process', '7. Design status monitoring', '8. Create follow-up workflow', '9. Identify automation opportunities', '10. Document submission workflow'], outputFormat: 'JSON with submission workflow' }, outputSchema: { type: 'object', required: ['workflow', 'automationOpportunities', 'artifacts'], properties: { workflow: { type: 'object' }, intakeProcess: { type: 'object' }, automationOpportunities: { type: 'array', items: { type: 'object' } }, urgentWorkflow: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'prior-auth', 'submission', 'healthcare'] }));

export const authTrackingTask = defineTask('auth-tracking', (args, taskCtx) => ({ kind: 'agent', title: 'Authorization Tracking System', agent: { name: 'tracking-specialist', prompt: { role: 'Auth Tracking Specialist', task: 'Design authorization tracking system', context: args, instructions: ['1. Design tracking database', '2. Create status monitoring', '3. Define alert/notification rules', '4. Design expiration tracking', '5. Create renewal reminders', '6. Define reporting requirements', '7. Design integration points', '8. Create audit trail', '9. Define access controls', '10. Document tracking system'], outputFormat: 'JSON with tracking system' }, outputSchema: { type: 'object', required: ['system', 'alerts', 'artifacts'], properties: { system: { type: 'object' }, statusWorkflow: { type: 'object' }, alerts: { type: 'array', items: { type: 'object' } }, integrations: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'prior-auth', 'tracking', 'healthcare'] }));

export const authAppealsTask = defineTask('auth-appeals', (args, taskCtx) => ({ kind: 'agent', title: 'Authorization Appeals Process', agent: { name: 'appeals-specialist', prompt: { role: 'Auth Appeals Specialist', task: 'Design authorization appeals process', context: args, instructions: ['1. Define appeal triggers', '2. Create appeal templates', '3. Design documentation requirements', '4. Define timeline management', '5. Create tracking workflow', '6. Design expedited appeals', '7. Define external review', '8. Create success tracking', '9. Design escalation paths', '10. Document appeals process'], outputFormat: 'JSON with appeals process' }, outputSchema: { type: 'object', required: ['workflow', 'templates', 'artifacts'], properties: { workflow: { type: 'object' }, templates: { type: 'array', items: { type: 'object' } }, timelines: { type: 'object' }, escalation: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'prior-auth', 'appeals', 'healthcare'] }));

export const peerToPeerTask = defineTask('peer-to-peer', (args, taskCtx) => ({ kind: 'agent', title: 'Peer-to-Peer Review Process', agent: { name: 'peer-review-specialist', prompt: { role: 'Peer-to-Peer Review Specialist', task: 'Design peer-to-peer review process', context: args, instructions: ['1. Define P2P criteria', '2. Create scheduling workflow', '3. Design preparation checklist', '4. Define documentation requirements', '5. Create talking points', '6. Design outcome tracking', '7. Define physician availability', '8. Create escalation process', '9. Design training program', '10. Document P2P process'], outputFormat: 'JSON with P2P process' }, outputSchema: { type: 'object', required: ['workflow', 'preparation', 'artifacts'], properties: { workflow: { type: 'object' }, preparation: { type: 'object' }, talkingPoints: { type: 'array', items: { type: 'object' } }, training: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'prior-auth', 'peer-review', 'healthcare'] }));

export const authAutomationTask = defineTask('auth-automation', (args, taskCtx) => ({ kind: 'agent', title: 'Authorization Automation Plan', agent: { name: 'automation-specialist', prompt: { role: 'Auth Automation Specialist', task: 'Design authorization automation', context: args, instructions: ['1. Assess automation opportunities', '2. Design portal integrations', '3. Create auto-submission rules', '4. Define status auto-check', '5. Design AI-assisted review', '6. Create documentation automation', '7. Define notification automation', '8. Design reporting automation', '9. Plan implementation phases', '10. Document automation plan'], outputFormat: 'JSON with automation plan' }, outputSchema: { type: 'object', required: ['plan', 'opportunities', 'artifacts'], properties: { plan: { type: 'object' }, opportunities: { type: 'array', items: { type: 'object' } }, integrations: { type: 'array', items: { type: 'object' } }, roi: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'prior-auth', 'automation', 'healthcare'] }));

export const authMetricsTask = defineTask('auth-metrics', (args, taskCtx) => ({ kind: 'agent', title: 'Authorization Metrics Program', agent: { name: 'metrics-analyst', prompt: { role: 'Auth Metrics Analyst', task: 'Design authorization metrics program', context: args, instructions: ['1. Define approval rate metrics', '2. Create turnaround time metrics', '3. Design volume metrics', '4. Define productivity metrics', '5. Create appeal success metrics', '6. Design cost metrics', '7. Define benchmark targets', '8. Create dashboard design', '9. Plan reporting cadence', '10. Document metrics program'], outputFormat: 'JSON with metrics program' }, outputSchema: { type: 'object', required: ['metrics', 'targets', 'artifacts'], properties: { metrics: { type: 'array', items: { type: 'object' } }, targets: { type: 'object' }, dashboard: { type: 'object' }, reporting: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'prior-auth', 'metrics', 'healthcare'] }));

export const authImplementationTask = defineTask('auth-implementation', (args, taskCtx) => ({ kind: 'agent', title: 'Authorization Workflow Implementation', agent: { name: 'implementation-manager', prompt: { role: 'Auth Implementation Manager', task: 'Plan workflow implementation', context: args, instructions: ['1. Create implementation phases', '2. Define resource requirements', '3. Plan training program', '4. Design communication plan', '5. Plan technology changes', '6. Define success criteria', '7. Create risk mitigation', '8. Plan change management', '9. Define go-live support', '10. Document implementation'], outputFormat: 'JSON with implementation plan' }, outputSchema: { type: 'object', required: ['plan', 'timeline', 'artifacts'], properties: { plan: { type: 'object' }, timeline: { type: 'object' }, resources: { type: 'object' }, training: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'prior-auth', 'implementation', 'healthcare'] }));

export const authDocumentationTask = defineTask('auth-documentation', (args, taskCtx) => ({ kind: 'agent', title: 'Authorization Workflow Documentation', agent: { name: 'documentation-writer', prompt: { role: 'Auth Documentation Writer', task: 'Document authorization workflow', context: args, instructions: ['1. Write executive summary', '2. Document current state', '3. Include requirements database', '4. Document submission workflow', '5. Include tracking system', '6. Document appeals process', '7. Include automation plan', '8. Document metrics program', '9. Create appendices', '10. Format professionally'], outputFormat: 'JSON with documentation' }, outputSchema: { type: 'object', required: ['documentPath', 'artifacts'], properties: { documentPath: { type: 'string' }, summary: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'prior-auth', 'documentation', 'healthcare'] }));
