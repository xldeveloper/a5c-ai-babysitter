/**
 * @process specializations/domains/social-sciences-humanities/healthcare/denial-prevention-management
 * @description Denial Prevention and Management - Proactive approach to preventing claim denials through
 * front-end processes, real-time eligibility, and systematic denial analysis with corrective action.
 * @inputs { organizationName: string, denialScope?: string, topDenialReasons?: array, currentMetrics?: object }
 * @outputs { success: boolean, preventionProgram: object, managementWorkflow: object, metrics: object, artifacts: array }
 */

import { defineTask } from '@a5c-ai/babysitter-sdk';

export async function process(inputs, ctx) {
  const { organizationName, denialScope = 'enterprise', topDenialReasons = [], currentMetrics = {}, outputDir = 'denial-prevention-output' } = inputs;
  const startTime = ctx.now();
  const artifacts = [];

  ctx.log('info', `Starting Denial Prevention and Management Program for: ${organizationName}`);

  const denialAnalysis = await ctx.task(denialAnalysisTask, { organizationName, denialScope, topDenialReasons, currentMetrics, outputDir });
  artifacts.push(...denialAnalysis.artifacts);

  await ctx.breakpoint({ question: `Denial analysis complete. Overall denial rate: ${denialAnalysis.denialRate}%. Top ${denialAnalysis.topReasons.length} denial reasons identified. Proceed?`, title: 'Denial Analysis Review', context: { runId: ctx.runId, denialRate: denialAnalysis.denialRate, topReasons: denialAnalysis.topReasons } });

  const preventionStrategies = await ctx.task(denialPreventionTask, { denialAnalysis, outputDir });
  artifacts.push(...preventionStrategies.artifacts);

  const eligibilityVerification = await ctx.task(eligibilityVerificationTask, { denialAnalysis, outputDir });
  artifacts.push(...eligibilityVerification.artifacts);

  const authorizationManagement = await ctx.task(authorizationManagementTask, { denialAnalysis, outputDir });
  artifacts.push(...authorizationManagement.artifacts);

  await ctx.breakpoint({ question: `Prevention strategies designed. ${preventionStrategies.strategies.length} prevention strategies. Proceed with management workflow?`, title: 'Prevention Strategies Review', context: { runId: ctx.runId, strategies: preventionStrategies.strategies } });

  const denialManagementWorkflow = await ctx.task(denialManagementWorkflowTask, { denialAnalysis, outputDir });
  artifacts.push(...denialManagementWorkflow.artifacts);

  const rootCauseProgram = await ctx.task(denialRootCauseTask, { denialAnalysis, outputDir });
  artifacts.push(...rootCauseProgram.artifacts);

  const payerRelations = await ctx.task(payerRelationsTask, { denialAnalysis, outputDir });
  artifacts.push(...payerRelations.artifacts);

  const metricsMonitoring = await ctx.task(denialMetricsTask, { denialAnalysis, outputDir });
  artifacts.push(...metricsMonitoring.artifacts);

  const implementationPlan = await ctx.task(denialImplementationTask, { preventionStrategies, denialManagementWorkflow, outputDir });
  artifacts.push(...implementationPlan.artifacts);

  const documentation = await ctx.task(denialDocumentationTask, { organizationName, denialAnalysis, preventionStrategies, eligibilityVerification, authorizationManagement, denialManagementWorkflow, rootCauseProgram, payerRelations, metricsMonitoring, implementationPlan, outputDir });
  artifacts.push(...documentation.artifacts);

  return { success: true, organizationName, preventionProgram: { strategies: preventionStrategies.strategies, eligibility: eligibilityVerification.workflow, authorization: authorizationManagement.workflow }, managementWorkflow: denialManagementWorkflow.workflow, metrics: metricsMonitoring.metrics, artifacts, duration: ctx.now() - startTime, metadata: { processId: 'specializations/domains/social-sciences-humanities/healthcare/denial-prevention-management', timestamp: startTime, outputDir } };
}

export const denialAnalysisTask = defineTask('denial-analysis', (args, taskCtx) => ({ kind: 'agent', title: 'Denial Analysis', agent: { name: 'denial-analyst', prompt: { role: 'Denial Analyst', task: 'Analyze denial patterns', context: args, instructions: ['1. Analyze denial rates by payer', '2. Identify top denial reasons', '3. Categorize denials (clinical/admin)', '4. Analyze denial trends', '5. Calculate financial impact', '6. Identify high-risk services', '7. Analyze denial by department', '8. Review appeal success rates', '9. Benchmark against industry', '10. Document analysis findings'], outputFormat: 'JSON with denial analysis' }, outputSchema: { type: 'object', required: ['denialRate', 'topReasons', 'artifacts'], properties: { denialRate: { type: 'number' }, topReasons: { type: 'array', items: { type: 'object' } }, financialImpact: { type: 'number' }, trends: { type: 'object' }, benchmarks: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'denial', 'analysis', 'healthcare'] }));

export const denialPreventionTask = defineTask('denial-prevention', (args, taskCtx) => ({ kind: 'agent', title: 'Denial Prevention Strategies', agent: { name: 'prevention-specialist', prompt: { role: 'Denial Prevention Specialist', task: 'Design denial prevention strategies', context: args, instructions: ['1. Design front-end prevention', '2. Create pre-registration checks', '3. Design point-of-service collection', '4. Create coding prevention', '5. Design documentation improvement', '6. Create charge capture prevention', '7. Design timely filing prevention', '8. Create medical necessity checks', '9. Design workflow changes', '10. Document prevention strategies'], outputFormat: 'JSON with prevention strategies' }, outputSchema: { type: 'object', required: ['strategies', 'workflows', 'artifacts'], properties: { strategies: { type: 'array', items: { type: 'object' } }, workflows: { type: 'array', items: { type: 'object' } }, expectedImpact: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'denial', 'prevention', 'healthcare'] }));

export const eligibilityVerificationTask = defineTask('eligibility-verification', (args, taskCtx) => ({ kind: 'agent', title: 'Eligibility Verification Process', agent: { name: 'eligibility-specialist', prompt: { role: 'Eligibility Verification Specialist', task: 'Design eligibility verification process', context: args, instructions: ['1. Design real-time verification', '2. Create batch verification', '3. Define verification timing', '4. Design coverage discovery', '5. Create coordination of benefits', '6. Define patient notification', '7. Design self-pay identification', '8. Create automation rules', '9. Define exception handling', '10. Document verification process'], outputFormat: 'JSON with eligibility workflow' }, outputSchema: { type: 'object', required: ['workflow', 'automationRules', 'artifacts'], properties: { workflow: { type: 'object' }, automationRules: { type: 'array', items: { type: 'object' } }, verificationPoints: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'denial', 'eligibility', 'healthcare'] }));

export const authorizationManagementTask = defineTask('authorization-management', (args, taskCtx) => ({ kind: 'agent', title: 'Authorization Management', agent: { name: 'authorization-specialist', prompt: { role: 'Authorization Management Specialist', task: 'Design authorization management', context: args, instructions: ['1. Define authorization requirements', '2. Create tracking system', '3. Design notification alerts', '4. Create retro-auth process', '5. Design urgent auth workflow', '6. Create documentation requirements', '7. Design payer integration', '8. Create expiration monitoring', '9. Define escalation process', '10. Document authorization workflow'], outputFormat: 'JSON with authorization workflow' }, outputSchema: { type: 'object', required: ['workflow', 'requirements', 'artifacts'], properties: { workflow: { type: 'object' }, requirements: { type: 'array', items: { type: 'object' } }, trackingSystem: { type: 'object' }, alerts: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'denial', 'authorization', 'healthcare'] }));

export const denialManagementWorkflowTask = defineTask('denial-management-workflow', (args, taskCtx) => ({ kind: 'agent', title: 'Denial Management Workflow', agent: { name: 'denial-management-specialist', prompt: { role: 'Denial Management Specialist', task: 'Design denial management workflow', context: args, instructions: ['1. Design denial identification', '2. Create categorization rules', '3. Design routing workflow', '4. Create work queue prioritization', '5. Design rework process', '6. Create appeal workflow', '7. Design tracking system', '8. Create escalation rules', '9. Define write-off criteria', '10. Document management workflow'], outputFormat: 'JSON with management workflow' }, outputSchema: { type: 'object', required: ['workflow', 'routingRules', 'artifacts'], properties: { workflow: { type: 'object' }, routingRules: { type: 'array', items: { type: 'object' } }, prioritization: { type: 'object' }, escalation: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'denial', 'management', 'healthcare'] }));

export const denialRootCauseTask = defineTask('denial-root-cause', (args, taskCtx) => ({ kind: 'agent', title: 'Denial Root Cause Program', agent: { name: 'root-cause-analyst', prompt: { role: 'Denial Root Cause Analyst', task: 'Design root cause analysis program', context: args, instructions: ['1. Define RCA methodology', '2. Create analysis templates', '3. Design data collection', '4. Define trend identification', '5. Create corrective action process', '6. Design feedback loops', '7. Create accountability structure', '8. Define monitoring process', '9. Design reporting', '10. Document RCA program'], outputFormat: 'JSON with RCA program' }, outputSchema: { type: 'object', required: ['rcaProgram', 'methodology', 'artifacts'], properties: { rcaProgram: { type: 'object' }, methodology: { type: 'object' }, templates: { type: 'array', items: { type: 'object' } }, feedbackLoops: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'denial', 'root-cause', 'healthcare'] }));

export const payerRelationsTask = defineTask('payer-relations', (args, taskCtx) => ({ kind: 'agent', title: 'Payer Relations Strategy', agent: { name: 'payer-relations-specialist', prompt: { role: 'Payer Relations Specialist', task: 'Design payer relations strategy', context: args, instructions: ['1. Analyze payer-specific denials', '2. Create payer communication plan', '3. Design JOC meetings', '4. Define escalation contacts', '5. Create contract review process', '6. Design dispute resolution', '7. Create payer scorecards', '8. Define relationship management', '9. Plan payer education', '10. Document payer strategy'], outputFormat: 'JSON with payer strategy' }, outputSchema: { type: 'object', required: ['payerStrategy', 'communicationPlan', 'artifacts'], properties: { payerStrategy: { type: 'object' }, communicationPlan: { type: 'object' }, scorecards: { type: 'object' }, escalationContacts: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'denial', 'payer-relations', 'healthcare'] }));

export const denialMetricsTask = defineTask('denial-metrics', (args, taskCtx) => ({ kind: 'agent', title: 'Denial Management Metrics', agent: { name: 'metrics-analyst', prompt: { role: 'Denial Metrics Analyst', task: 'Design denial metrics program', context: args, instructions: ['1. Define denial rate metrics', '2. Create prevention metrics', '3. Design appeal success metrics', '4. Define financial impact metrics', '5. Create trending metrics', '6. Design productivity metrics', '7. Define benchmark targets', '8. Create dashboard design', '9. Plan reporting cadence', '10. Document metrics program'], outputFormat: 'JSON with metrics program' }, outputSchema: { type: 'object', required: ['metrics', 'targets', 'artifacts'], properties: { metrics: { type: 'array', items: { type: 'object' } }, targets: { type: 'object' }, dashboard: { type: 'object' }, reporting: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'denial', 'metrics', 'healthcare'] }));

export const denialImplementationTask = defineTask('denial-implementation', (args, taskCtx) => ({ kind: 'agent', title: 'Denial Program Implementation', agent: { name: 'implementation-manager', prompt: { role: 'Denial Program Implementation Manager', task: 'Plan program implementation', context: args, instructions: ['1. Create implementation phases', '2. Define resource requirements', '3. Plan training program', '4. Design communication plan', '5. Plan technology changes', '6. Define success criteria', '7. Create risk mitigation', '8. Plan change management', '9. Define go-live support', '10. Document implementation'], outputFormat: 'JSON with implementation plan' }, outputSchema: { type: 'object', required: ['plan', 'timeline', 'artifacts'], properties: { plan: { type: 'object' }, timeline: { type: 'object' }, resources: { type: 'object' }, training: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'denial', 'implementation', 'healthcare'] }));

export const denialDocumentationTask = defineTask('denial-documentation', (args, taskCtx) => ({ kind: 'agent', title: 'Denial Program Documentation', agent: { name: 'documentation-writer', prompt: { role: 'Denial Program Documentation Writer', task: 'Document denial program', context: args, instructions: ['1. Write executive summary', '2. Document denial analysis', '3. Include prevention strategies', '4. Document management workflow', '5. Include root cause program', '6. Document payer strategy', '7. Include metrics program', '8. Document implementation', '9. Create appendices', '10. Format professionally'], outputFormat: 'JSON with documentation' }, outputSchema: { type: 'object', required: ['documentPath', 'artifacts'], properties: { documentPath: { type: 'string' }, summary: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'denial', 'documentation', 'healthcare'] }));
