/**
 * @process specializations/domains/social-sciences-humanities/healthcare/medical-coding-compliance
 * @description Medical Coding Compliance - Framework for accurate and compliant ICD-10, CPT, and HCPCS
 * coding through education, audit programs, and documentation improvement.
 * @inputs { organizationName: string, codingScope?: string, focusAreas?: array, currentMetrics?: object }
 * @outputs { success: boolean, complianceProgram: object, auditProgram: object, educationPlan: object, artifacts: array }
 */

import { defineTask } from '@a5c-ai/babysitter-sdk';

export async function process(inputs, ctx) {
  const { organizationName, codingScope = 'enterprise', focusAreas = [], currentMetrics = {}, outputDir = 'coding-compliance-output' } = inputs;
  const startTime = ctx.now();
  const artifacts = [];

  ctx.log('info', `Starting Medical Coding Compliance Program for: ${organizationName}`);

  const currentStateAssessment = await ctx.task(codingCurrentStateTask, { organizationName, codingScope, currentMetrics, outputDir });
  artifacts.push(...currentStateAssessment.artifacts);

  await ctx.breakpoint({ question: `Current state assessed. Accuracy rate: ${currentStateAssessment.accuracyRate}%. ${currentStateAssessment.riskAreas.length} risk areas identified. Proceed?`, title: 'Coding Compliance Assessment', context: { runId: ctx.runId, accuracy: currentStateAssessment.accuracyRate, risks: currentStateAssessment.riskAreas } });

  const compliancePolicies = await ctx.task(codingCompliancePoliciesTask, { currentStateAssessment, outputDir });
  artifacts.push(...compliancePolicies.artifacts);

  const auditProgram = await ctx.task(codingAuditProgramTask, { currentStateAssessment, focusAreas, outputDir });
  artifacts.push(...auditProgram.artifacts);

  const educationProgram = await ctx.task(codingEducationTask, { currentStateAssessment, auditProgram, outputDir });
  artifacts.push(...educationProgram.artifacts);

  await ctx.breakpoint({ question: `Audit program covers ${auditProgram.auditTypes.length} audit types. Education includes ${educationProgram.modules.length} modules. Proceed with monitoring design?`, title: 'Audit and Education Review', context: { runId: ctx.runId, audits: auditProgram.auditTypes, education: educationProgram.modules } });

  const queryManagement = await ctx.task(codingQueryManagementTask, { compliancePolicies, outputDir });
  artifacts.push(...queryManagement.artifacts);

  const denialManagement = await ctx.task(codingDenialManagementTask, { currentStateAssessment, outputDir });
  artifacts.push(...denialManagement.artifacts);

  const metricsMonitoring = await ctx.task(codingMetricsTask, { currentStateAssessment, auditProgram, outputDir });
  artifacts.push(...metricsMonitoring.artifacts);

  const implementationPlan = await ctx.task(codingImplementationTask, { compliancePolicies, auditProgram, educationProgram, outputDir });
  artifacts.push(...implementationPlan.artifacts);

  const documentation = await ctx.task(codingComplianceDocumentationTask, { organizationName, currentStateAssessment, compliancePolicies, auditProgram, educationProgram, queryManagement, denialManagement, metricsMonitoring, implementationPlan, outputDir });
  artifacts.push(...documentation.artifacts);

  return { success: true, organizationName, complianceProgram: { policies: compliancePolicies.policies, riskAreas: currentStateAssessment.riskAreas }, auditProgram: auditProgram.program, educationPlan: educationProgram.program, metrics: metricsMonitoring.metrics, artifacts, duration: ctx.now() - startTime, metadata: { processId: 'specializations/domains/social-sciences-humanities/healthcare/medical-coding-compliance', timestamp: startTime, outputDir } };
}

export const codingCurrentStateTask = defineTask('coding-current-state', (args, taskCtx) => ({ kind: 'agent', title: 'Coding Compliance Current State', agent: { name: 'coding-compliance-analyst', prompt: { role: 'Coding Compliance Analyst', task: 'Assess current coding compliance state', context: args, instructions: ['1. Review current coding accuracy rates', '2. Analyze denial rates by reason', '3. Review external audit findings', '4. Assess coder credentials', '5. Review coding productivity', '6. Identify high-risk areas', '7. Assess documentation quality', '8. Review regulatory compliance', '9. Benchmark against industry', '10. Document findings'], outputFormat: 'JSON with current state' }, outputSchema: { type: 'object', required: ['accuracyRate', 'riskAreas', 'artifacts'], properties: { accuracyRate: { type: 'number' }, denialRates: { type: 'object' }, riskAreas: { type: 'array', items: { type: 'object' } }, benchmarks: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'coding', 'compliance', 'healthcare'] }));

export const codingCompliancePoliciesTask = defineTask('coding-policies', (args, taskCtx) => ({ kind: 'agent', title: 'Coding Compliance Policies', agent: { name: 'compliance-policy-writer', prompt: { role: 'Coding Compliance Policy Writer', task: 'Develop coding compliance policies', context: args, instructions: ['1. Define coding compliance standards', '2. Create coding guidelines by specialty', '3. Develop query policies', '4. Define documentation requirements', '5. Create compliance escalation', '6. Define corrective action process', '7. Create conflict of interest policy', '8. Define credential requirements', '9. Create retention policies', '10. Document all policies'], outputFormat: 'JSON with policies' }, outputSchema: { type: 'object', required: ['policies', 'guidelines', 'artifacts'], properties: { policies: { type: 'array', items: { type: 'object' } }, guidelines: { type: 'array', items: { type: 'object' } }, standards: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'coding', 'policies', 'healthcare'] }));

export const codingAuditProgramTask = defineTask('coding-audit', (args, taskCtx) => ({ kind: 'agent', title: 'Coding Audit Program', agent: { name: 'coding-auditor', prompt: { role: 'Coding Audit Manager', task: 'Design coding audit program', context: args, instructions: ['1. Define audit types (prospective, concurrent, retrospective)', '2. Create audit sampling methodology', '3. Design audit tools and checklists', '4. Define audit frequency', '5. Create audit reporting', '6. Design corrective action process', '7. Plan external audit preparation', '8. Define audit metrics', '9. Create trending analysis', '10. Document audit program'], outputFormat: 'JSON with audit program' }, outputSchema: { type: 'object', required: ['program', 'auditTypes', 'methodology', 'artifacts'], properties: { program: { type: 'object' }, auditTypes: { type: 'array', items: { type: 'object' } }, methodology: { type: 'object' }, tools: { type: 'array', items: { type: 'object' } }, metrics: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'coding', 'audit', 'healthcare'] }));

export const codingEducationTask = defineTask('coding-education', (args, taskCtx) => ({ kind: 'agent', title: 'Coding Education Program', agent: { name: 'coding-educator', prompt: { role: 'Coding Education Specialist', task: 'Design coding education program', context: args, instructions: ['1. Define education objectives', '2. Create ongoing education curriculum', '3. Design specialty-specific training', '4. Plan regulatory update education', '5. Create new coder orientation', '6. Design competency assessments', '7. Plan credential support', '8. Create educational resources', '9. Design feedback mechanisms', '10. Document education program'], outputFormat: 'JSON with education program' }, outputSchema: { type: 'object', required: ['program', 'modules', 'assessments', 'artifacts'], properties: { program: { type: 'object' }, modules: { type: 'array', items: { type: 'object' } }, curriculum: { type: 'object' }, assessments: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'coding', 'education', 'healthcare'] }));

export const codingQueryManagementTask = defineTask('coding-query', (args, taskCtx) => ({ kind: 'agent', title: 'Coding Query Management', agent: { name: 'query-manager', prompt: { role: 'Coding Query Manager', task: 'Design query management process', context: args, instructions: ['1. Define compliant query criteria', '2. Create query templates', '3. Design query workflow', '4. Define response requirements', '5. Create escalation process', '6. Design quality review', '7. Plan compliance monitoring', '8. Create query metrics', '9. Design feedback loop', '10. Document query process'], outputFormat: 'JSON with query management' }, outputSchema: { type: 'object', required: ['queryProcess', 'templates', 'artifacts'], properties: { queryProcess: { type: 'object' }, templates: { type: 'array', items: { type: 'object' } }, workflow: { type: 'object' }, metrics: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'coding', 'query', 'healthcare'] }));

export const codingDenialManagementTask = defineTask('coding-denial', (args, taskCtx) => ({ kind: 'agent', title: 'Coding Denial Management', agent: { name: 'denial-analyst', prompt: { role: 'Coding Denial Analyst', task: 'Design denial management for coding', context: args, instructions: ['1. Analyze denial patterns', '2. Identify root causes', '3. Design prevention strategies', '4. Create appeal templates', '5. Design tracking system', '6. Plan trend analysis', '7. Create feedback to coders', '8. Design payer collaboration', '9. Define success metrics', '10. Document denial management'], outputFormat: 'JSON with denial management' }, outputSchema: { type: 'object', required: ['denialManagement', 'preventionStrategies', 'artifacts'], properties: { denialManagement: { type: 'object' }, patterns: { type: 'array', items: { type: 'object' } }, preventionStrategies: { type: 'array', items: { type: 'object' } }, appealProcess: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'coding', 'denial', 'healthcare'] }));

export const codingMetricsTask = defineTask('coding-metrics', (args, taskCtx) => ({ kind: 'agent', title: 'Coding Compliance Metrics', agent: { name: 'metrics-analyst', prompt: { role: 'Coding Metrics Analyst', task: 'Design coding compliance metrics', context: args, instructions: ['1. Define accuracy metrics', '2. Define productivity metrics', '3. Define compliance metrics', '4. Set targets', '5. Design dashboard', '6. Plan reporting frequency', '7. Create scorecards', '8. Design trend analysis', '9. Plan benchmarking', '10. Document metrics program'], outputFormat: 'JSON with metrics program' }, outputSchema: { type: 'object', required: ['metrics', 'targets', 'dashboard', 'artifacts'], properties: { metrics: { type: 'array', items: { type: 'object' } }, targets: { type: 'object' }, dashboard: { type: 'object' }, scorecards: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'coding', 'metrics', 'healthcare'] }));

export const codingImplementationTask = defineTask('coding-implementation', (args, taskCtx) => ({ kind: 'agent', title: 'Coding Compliance Implementation', agent: { name: 'implementation-manager', prompt: { role: 'Coding Implementation Manager', task: 'Plan compliance implementation', context: args, instructions: ['1. Create implementation timeline', '2. Define resource requirements', '3. Plan training rollout', '4. Design communication plan', '5. Plan technology needs', '6. Define success criteria', '7. Create risk mitigation', '8. Plan change management', '9. Define governance', '10. Document implementation'], outputFormat: 'JSON with implementation plan' }, outputSchema: { type: 'object', required: ['plan', 'timeline', 'artifacts'], properties: { plan: { type: 'object' }, timeline: { type: 'object' }, resources: { type: 'object' }, risks: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'coding', 'implementation', 'healthcare'] }));

export const codingComplianceDocumentationTask = defineTask('coding-documentation', (args, taskCtx) => ({ kind: 'agent', title: 'Coding Compliance Documentation', agent: { name: 'documentation-writer', prompt: { role: 'Compliance Documentation Writer', task: 'Document coding compliance program', context: args, instructions: ['1. Write executive summary', '2. Document policies', '3. Include audit program', '4. Document education', '5. Include metrics', '6. Document query process', '7. Include denial management', '8. Document implementation', '9. Create appendices', '10. Format professionally'], outputFormat: 'JSON with documentation' }, outputSchema: { type: 'object', required: ['documentPath', 'artifacts'], properties: { documentPath: { type: 'string' }, summary: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'coding', 'documentation', 'healthcare'] }));
