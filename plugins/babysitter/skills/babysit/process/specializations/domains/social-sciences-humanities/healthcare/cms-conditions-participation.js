/**
 * @process specializations/domains/social-sciences-humanities/healthcare/cms-conditions-participation
 * @description CMS Conditions of Participation Compliance - Framework for achieving and maintaining
 * compliance with Medicare/Medicaid Conditions of Participation for healthcare facilities.
 * @inputs { organizationName: string, facilityType?: string, copScope?: array, currentCompliance?: object }
 * @outputs { success: boolean, complianceAssessment: object, remediationPlan: object, policies: array, artifacts: array }
 */

import { defineTask } from '@a5c-ai/babysitter-sdk';

export async function process(inputs, ctx) {
  const { organizationName, facilityType = 'hospital', copScope = [], currentCompliance = {}, outputDir = 'cms-cop-output' } = inputs;
  const startTime = ctx.now();
  const artifacts = [];

  ctx.log('info', `Starting CMS Conditions of Participation Compliance for: ${organizationName}`);

  const copAssessment = await ctx.task(copAssessmentTask, { organizationName, facilityType, copScope, currentCompliance, outputDir });
  artifacts.push(...copAssessment.artifacts);

  await ctx.breakpoint({ question: `CoP assessment complete. Compliance rate: ${copAssessment.complianceRate}%. ${copAssessment.immediateJeopardy.length} immediate jeopardy conditions found. Proceed?`, title: 'CoP Assessment Review', context: { runId: ctx.runId, rate: copAssessment.complianceRate, ij: copAssessment.immediateJeopardy } });

  const patientRightsCompliance = await ctx.task(copPatientRightsTask, { copAssessment, outputDir });
  artifacts.push(...patientRightsCompliance.artifacts);

  const qapipCompliance = await ctx.task(copQAPITask, { copAssessment, outputDir });
  artifacts.push(...qapipCompliance.artifacts);

  const infectionControlCompliance = await ctx.task(copInfectionControlTask, { copAssessment, outputDir });
  artifacts.push(...infectionControlCompliance.artifacts);

  await ctx.breakpoint({ question: `Core CoPs assessed. Patient Rights: ${patientRightsCompliance.status}, QAPI: ${qapipCompliance.status}, Infection Control: ${infectionControlCompliance.status}. Proceed?`, title: 'Core CoP Review', context: { runId: ctx.runId, patientRights: patientRightsCompliance.status, qapi: qapipCompliance.status, ic: infectionControlCompliance.status } });

  const nursingServicesCompliance = await ctx.task(copNursingTask, { copAssessment, outputDir });
  artifacts.push(...nursingServicesCompliance.artifacts);

  const medicalStaffCompliance = await ctx.task(copMedicalStaffTask, { copAssessment, outputDir });
  artifacts.push(...medicalStaffCompliance.artifacts);

  const medicationManagementCompliance = await ctx.task(copMedicationTask, { copAssessment, outputDir });
  artifacts.push(...medicationManagementCompliance.artifacts);

  const emergencyServicesCompliance = await ctx.task(copEmergencyTask, { copAssessment, facilityType, outputDir });
  artifacts.push(...emergencyServicesCompliance.artifacts);

  const remediationPlan = await ctx.task(copRemediationTask, { copAssessment, patientRightsCompliance, qapipCompliance, infectionControlCompliance, nursingServicesCompliance, outputDir });
  artifacts.push(...remediationPlan.artifacts);

  const surveyPreparation = await ctx.task(copSurveyPrepTask, { copAssessment, remediationPlan, outputDir });
  artifacts.push(...surveyPreparation.artifacts);

  const documentation = await ctx.task(copDocumentationTask, { organizationName, copAssessment, patientRightsCompliance, qapipCompliance, infectionControlCompliance, nursingServicesCompliance, medicalStaffCompliance, medicationManagementCompliance, emergencyServicesCompliance, remediationPlan, surveyPreparation, outputDir });
  artifacts.push(...documentation.artifacts);

  return { success: true, organizationName, complianceAssessment: { complianceRate: copAssessment.complianceRate, immediateJeopardy: copAssessment.immediateJeopardy, conditionLevel: copAssessment.conditionLevelDeficiencies }, remediationPlan: remediationPlan.plan, policies: [...patientRightsCompliance.policies, ...qapipCompliance.policies], artifacts, duration: ctx.now() - startTime, metadata: { processId: 'specializations/domains/social-sciences-humanities/healthcare/cms-conditions-participation', timestamp: startTime, outputDir } };
}

export const copAssessmentTask = defineTask('cop-assessment', (args, taskCtx) => ({ kind: 'agent', title: 'CoP Compliance Assessment', agent: { name: 'cop-surveyor', prompt: { role: 'CMS CoP Surveyor', task: 'Assess Conditions of Participation compliance', context: args, instructions: ['1. Review all applicable CoPs', '2. Identify immediate jeopardy conditions', '3. Assess condition-level deficiencies', '4. Review standard-level deficiencies', '5. Evaluate patient care processes', '6. Assess governance compliance', '7. Review quality indicators', '8. Assess physical environment', '9. Calculate compliance rate', '10. Document assessment findings'], outputFormat: 'JSON with CoP assessment' }, outputSchema: { type: 'object', required: ['complianceRate', 'immediateJeopardy', 'artifacts'], properties: { complianceRate: { type: 'number' }, immediateJeopardy: { type: 'array', items: { type: 'object' } }, conditionLevelDeficiencies: { type: 'array', items: { type: 'object' } }, standardLevelDeficiencies: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'cms-cop', 'assessment', 'healthcare'] }));

export const copPatientRightsTask = defineTask('cop-patient-rights', (args, taskCtx) => ({ kind: 'agent', title: 'Patient Rights CoP Compliance', agent: { name: 'patient-rights-specialist', prompt: { role: 'Patient Rights Specialist', task: 'Assess patient rights compliance', context: args, instructions: ['1. Review notice of rights', '2. Assess grievance process', '3. Review informed consent', '4. Assess advance directives', '5. Review restraint/seclusion', '6. Assess privacy protections', '7. Review patient abuse prevention', '8. Assess visitation rights', '9. Document gaps', '10. Create remediation plan'], outputFormat: 'JSON with patient rights assessment' }, outputSchema: { type: 'object', required: ['status', 'policies', 'artifacts'], properties: { status: { type: 'string' }, findings: { type: 'array', items: { type: 'object' } }, policies: { type: 'array', items: { type: 'object' } }, remediation: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'cms-cop', 'patient-rights', 'healthcare'] }));

export const copQAPITask = defineTask('cop-qapi', (args, taskCtx) => ({ kind: 'agent', title: 'QAPI Program Compliance', agent: { name: 'qapi-specialist', prompt: { role: 'QAPI Program Specialist', task: 'Assess QAPI compliance', context: args, instructions: ['1. Review QAPI plan', '2. Assess performance improvement projects', '3. Review data collection', '4. Assess action plan effectiveness', '5. Review governing body involvement', '6. Assess staff involvement', '7. Review feedback mechanisms', '8. Assess systematic analysis', '9. Document gaps', '10. Create remediation plan'], outputFormat: 'JSON with QAPI assessment' }, outputSchema: { type: 'object', required: ['status', 'policies', 'artifacts'], properties: { status: { type: 'string' }, qapiPlan: { type: 'object' }, projects: { type: 'array', items: { type: 'object' } }, gaps: { type: 'array', items: { type: 'object' } }, policies: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'cms-cop', 'qapi', 'healthcare'] }));

export const copInfectionControlTask = defineTask('cop-infection-control', (args, taskCtx) => ({ kind: 'agent', title: 'Infection Control CoP Compliance', agent: { name: 'infection-control-specialist', prompt: { role: 'Infection Control Specialist', task: 'Assess infection control compliance', context: args, instructions: ['1. Review IC program', '2. Assess surveillance system', '3. Review hand hygiene', '4. Assess isolation practices', '5. Review antibiotic stewardship', '6. Assess environmental cleaning', '7. Review staff education', '8. Assess outbreak management', '9. Document gaps', '10. Create remediation plan'], outputFormat: 'JSON with IC assessment' }, outputSchema: { type: 'object', required: ['status', 'findings', 'artifacts'], properties: { status: { type: 'string' }, program: { type: 'object' }, findings: { type: 'array', items: { type: 'object' } }, gaps: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'cms-cop', 'infection-control', 'healthcare'] }));

export const copNursingTask = defineTask('cop-nursing', (args, taskCtx) => ({ kind: 'agent', title: 'Nursing Services CoP Compliance', agent: { name: 'nursing-compliance-specialist', prompt: { role: 'Nursing Compliance Specialist', task: 'Assess nursing services compliance', context: args, instructions: ['1. Review nursing leadership', '2. Assess staffing plans', '3. Review competency validation', '4. Assess patient assessments', '5. Review care planning', '6. Assess nursing documentation', '7. Review supervision of care', '8. Assess nurse communication', '9. Document gaps', '10. Create remediation plan'], outputFormat: 'JSON with nursing assessment' }, outputSchema: { type: 'object', required: ['status', 'findings', 'artifacts'], properties: { status: { type: 'string' }, staffing: { type: 'object' }, findings: { type: 'array', items: { type: 'object' } }, gaps: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'cms-cop', 'nursing', 'healthcare'] }));

export const copMedicalStaffTask = defineTask('cop-medical-staff', (args, taskCtx) => ({ kind: 'agent', title: 'Medical Staff CoP Compliance', agent: { name: 'medical-staff-specialist', prompt: { role: 'Medical Staff Compliance Specialist', task: 'Assess medical staff compliance', context: args, instructions: ['1. Review medical staff bylaws', '2. Assess credentialing process', '3. Review privileging process', '4. Assess peer review', '5. Review FPPE/OPPE', '6. Assess medical staff governance', '7. Review medical executive committee', '8. Assess contracted physicians', '9. Document gaps', '10. Create remediation plan'], outputFormat: 'JSON with medical staff assessment' }, outputSchema: { type: 'object', required: ['status', 'findings', 'artifacts'], properties: { status: { type: 'string' }, bylaws: { type: 'object' }, credentialing: { type: 'object' }, findings: { type: 'array', items: { type: 'object' } }, gaps: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'cms-cop', 'medical-staff', 'healthcare'] }));

export const copMedicationTask = defineTask('cop-medication', (args, taskCtx) => ({ kind: 'agent', title: 'Medication Management CoP Compliance', agent: { name: 'medication-safety-specialist', prompt: { role: 'Medication Safety Specialist', task: 'Assess medication management compliance', context: args, instructions: ['1. Review pharmacy services', '2. Assess medication storage', '3. Review medication administration', '4. Assess high-alert medications', '5. Review medication reconciliation', '6. Assess controlled substances', '7. Review adverse drug events', '8. Assess formulary management', '9. Document gaps', '10. Create remediation plan'], outputFormat: 'JSON with medication assessment' }, outputSchema: { type: 'object', required: ['status', 'findings', 'artifacts'], properties: { status: { type: 'string' }, pharmacyServices: { type: 'object' }, findings: { type: 'array', items: { type: 'object' } }, gaps: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'cms-cop', 'medication', 'healthcare'] }));

export const copEmergencyTask = defineTask('cop-emergency', (args, taskCtx) => ({ kind: 'agent', title: 'Emergency Services CoP Compliance', agent: { name: 'emergency-services-specialist', prompt: { role: 'Emergency Services Specialist', task: 'Assess emergency services compliance', context: args, instructions: ['1. Review ED organization', '2. Assess EMTALA compliance', '3. Review triage process', '4. Assess staffing coverage', '5. Review emergency equipment', '6. Assess transfer protocols', '7. Review on-call coverage', '8. Assess medical screening', '9. Document gaps', '10. Create remediation plan'], outputFormat: 'JSON with emergency assessment' }, outputSchema: { type: 'object', required: ['status', 'findings', 'artifacts'], properties: { status: { type: 'string' }, emtalaCompliance: { type: 'object' }, findings: { type: 'array', items: { type: 'object' } }, gaps: { type: 'array', items: { type: 'object' } }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'cms-cop', 'emergency', 'healthcare'] }));

export const copRemediationTask = defineTask('cop-remediation', (args, taskCtx) => ({ kind: 'agent', title: 'CoP Remediation Plan', agent: { name: 'remediation-specialist', prompt: { role: 'CoP Remediation Specialist', task: 'Create remediation plan', context: args, instructions: ['1. Prioritize immediate jeopardy', '2. Address condition-level', '3. Plan standard-level fixes', '4. Create timeline', '5. Assign responsibility', '6. Define resources', '7. Create tracking system', '8. Define success criteria', '9. Plan verification', '10. Document remediation plan'], outputFormat: 'JSON with remediation plan' }, outputSchema: { type: 'object', required: ['plan', 'priorities', 'artifacts'], properties: { plan: { type: 'object' }, priorities: { type: 'array', items: { type: 'object' } }, timeline: { type: 'object' }, tracking: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'cms-cop', 'remediation', 'healthcare'] }));

export const copSurveyPrepTask = defineTask('cop-survey-prep', (args, taskCtx) => ({ kind: 'agent', title: 'CMS Survey Preparation', agent: { name: 'survey-prep-specialist', prompt: { role: 'CMS Survey Preparation Specialist', task: 'Prepare for CMS survey', context: args, instructions: ['1. Create survey day plan', '2. Prepare document requests', '3. Train staff on survey', '4. Prepare leadership team', '5. Create communication plan', '6. Design entrance conference', '7. Plan survey coordination', '8. Prepare for interviews', '9. Create exit conference plan', '10. Document survey preparation'], outputFormat: 'JSON with survey preparation' }, outputSchema: { type: 'object', required: ['surveyPrep', 'staffTraining', 'artifacts'], properties: { surveyPrep: { type: 'object' }, staffTraining: { type: 'object' }, documentPrep: { type: 'array', items: { type: 'object' } }, communicationPlan: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'cms-cop', 'survey-prep', 'healthcare'] }));

export const copDocumentationTask = defineTask('cop-documentation', (args, taskCtx) => ({ kind: 'agent', title: 'CoP Compliance Documentation', agent: { name: 'documentation-writer', prompt: { role: 'CoP Documentation Writer', task: 'Document CoP compliance program', context: args, instructions: ['1. Write executive summary', '2. Document CoP assessment', '3. Include patient rights', '4. Document QAPI', '5. Include infection control', '6. Document nursing services', '7. Include medical staff', '8. Document remediation', '9. Include survey preparation', '10. Format professionally'], outputFormat: 'JSON with documentation' }, outputSchema: { type: 'object', required: ['documentPath', 'artifacts'], properties: { documentPath: { type: 'string' }, summary: { type: 'object' }, artifacts: { type: 'array' } } } }, io: { inputJsonPath: `tasks/${taskCtx.effectId}/input.json`, outputJsonPath: `tasks/${taskCtx.effectId}/result.json` }, labels: ['agent', 'cms-cop', 'documentation', 'healthcare'] }));
